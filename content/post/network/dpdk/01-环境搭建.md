---
title: dpdk学习01—环境搭建
slug: /network/dpdk/01
description: dpdk学习01—环境搭建
date: 2024-04-22T19:16:59+08:00
lastmod: 2024-04-22T19:16:59+08:00
draft: false
toc: true
weight: false
image: ""
categories:
  - network
  - DPDK
tags:
  - dpdk
---
## 什么是dpdk？

dpdk是intel开源的一个网络加速工具包，目的是在IA平台上解决高性能网络数据包处理的问题。  
传统网络包处理的过程是：
1. 网卡收到数据包
2. 网卡将帧DMA到内存
3. 网卡发送硬中断
4. cpu响应中断，调用对应函数进行收包
5. 将ring buffer保存到skb
6. 内核协议栈处理帧
7. 用户进程处理报文  

因为传统网络包处理是中断驱动的，所以在大量网络请求下会出现irq风暴，降低处理性能。除此之外还涉及到多次用户态和内核态数据拷贝，降低性能。当时流行的做法是通过硬件来加速网络包处理，但是dpdk的产生证明了通用化硬件在软件极致优化的情况下也能做到达到io的极限。
基于IA处理器的DPDK技术，很好地解决高性能数据包处理的问题，这些技术包括：
- 通过轮询来处理数据包，避免中断上下文切换的开销
- 使用用户态驱动，避免内核态到用户态不必要的内存拷贝和系统调用
- 设置cpu亲和性与独占，避免线程在不同核心间频繁切换; 限制某些核心不参与Linux系统调试, 可使线程独占该核心
- 利用大页内存降低TLB miss
### dpdk安装
环境：Mac m1，Vmware Fusion 虚拟机，Ubuntu 20.04  
版本：dpdk 22.11.4  
因为ubuntu已经有了dpdk的二进制源，直接安装即可，如果需要二进制安装，可参考[官方文档](https://core.dpdk.org/doc/quick-start/)：
```bash
apt install -yq dpdk dpdk-dev dpdk-doc gcc g++
```

### 配置环境
dpdk环境最好配置2张网卡，一个选择桥接，用来配置dpdk开发；一个选择NAT，用来和宿主机连接。cpu选择4核，内存选择8G，按宿主机资源即可。
配置dpdk环境需要2步：
1. 将网卡和dpdk绑定
2. 设置内存大页
dpdk安装时已经自带了工具，可以很方便的配置：  
`dpdk-devbind.py dpdk-hugepages.py`
以下给出自己写的配置脚本：
```bash
root@ubuntu:~# cat scripts/dpdk-run.sh
#!/bin/bash

# var
down_nics=()
choice=""
selected_nics=()

# 检查并输出DOWN状态的网络接口
function find_down_nics {
    ip a | grep 'ens.*DOWN' | awk -F: '{print $2}' | tr -d ' '
}
down_nics=($(find_down_nics))

# 检查是否有DOWN的接口
if [ ${#down_nics[@]} -eq 0 ]; then
    echo "没有找到DOWN状态的网络接口。"
    exit 0
fi

# 打印选项
echo "请选择DOWN的网络接口："
for ((i=0; i<${#down_nics[@]}; i++)); do
    echo "$((i+1)). ${down_nics[i]}"
done
echo "$(( ${#down_nics[@]} + 1 )). all"

# 读取用户选择
read -p "请输入选项编号： " choice

if [ "$choice" == "$(( ${#down_nics[@]} + 1 ))" ]; then
    echo "您选择了所有DOWN的网络接口。"
    selected_nics=("${down_nics[@]}")
else
    if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -le "${#down_nics[@]}" ]; then
        echo "您选择了接口：${down_nics[$((choice-1))]}"
        selected_nics=("${down_nics[$((choice-1))]}")
    else
        echo "无效的选择。"
        exit 1
    fi
fi

# log选定的接口信息（包括IP地址）
function log_selected_nics {
    # 确保bind.log存在
    > bind.log

    for nic in "${selected_nics[@]}"; do
        # 尝试获取MAC地址
        mac_address=$(ip link show "$nic" |  awk  '/link/ {print $2}')
        if [ -z "$mac_address" ]; then
            mac_address="无法获取"
        fi

        # 尝试获取IPv4地址
        ip_address=$(ip addr show "$nic" | grep -oP '(?<=inet\s)\d+(\.\d+){3}/\d+')
        if [ -z "$ip_address" ]; then
            ip_address="未分配"
        fi

        # 将接口名、MAC地址和IP地址写入文件
        echo "绑定接口名称: $nic, MAC地址: $mac_address, IP地址: $ip_address"
        echo "绑定接口名称: $nic, MAC地址: $mac_address, IP地址: $ip_address" >> bind.log
    done
}

log_selected_nics

# 将选定的网络接口绑定到dpdk
function bind_dpdk_nics {
    for nic in "${selected_nics[@]}"; do
        # 检查接口是否存在并尝试绑定
        if ip link show "$nic" > /dev/null 2>&1; then
            echo "正在绑定接口 $nic 到 vfio-pci..."
            sudo dpdk-devbind.py --bind=vfio-pci "$nic"
            if [ $? -eq 0 ]; then
                echo "接口 $nic 绑定成功。"
            else
                echo "绑定接口 $nic 失败，请检查错误。"
            fi
        else
            echo "接口 $nic 不存在，跳过绑定。"
        fi
    done
}

# 执行绑定操作
if [ ${#selected_nics[@]} -gt 0 ]; then
    bind_dpdk_nics
else
    echo "没有接口被选中进行绑定。"
    exit 0
fi

# 配置大页
function setup_huge_pages {
    # 示例命令配置2GB的1G大页
    sudo dpdk-hugepages.py -p 1G --setup 2G
    if [ $? -eq 0 ]; then
        echo "大页配置成功。"
    else
        echo "配置大页失败，请检查错误。"
    fi
}

# 在执行完网络接口绑定之后，配置大页
echo "开始配置大页..."
setup_huge_pages


printf "dpdk 配置完成\n"
exit 0
```
## 第一个测试程序
测试程序使用dpdk官方提供的testpmd，测试dpdk网卡绑定 。  
因为网卡绑定到dpdk后无法查看ip和mac，所以绑定前需要保留这些信息，如果是运行脚本搭建，相关信息就在bind.log里。  
测试环境： 两台虚拟机，要求都已经安装了dpdk的环境。
## 安装pktgen
```bash
git clone git://dpdk.org/apps/pktgen-dpdk
cd pktgen-dpdk/
meson build
cd build
ninja
# app/pktgen 编译出的程序
mv app/pktgen /usr/local/bin
```
## 开始测试

node1  node2 mac信息
```bash
node1
绑定接口名称: ens161, MAC地址: 00:0c:29:a5:21:1e, IP地址: 未分配
绑定接口名称: ens256, MAC地址: 00:0c:29:a5:21:14, IP地址: 未分配
node2
绑定接口名称: ens161, MAC地址: 00:0c:29:57:f0:2f, IP地址: 未分配
绑定接口名称: ens256, MAC地址: 00:0c:29:57:f0:25, IP地址: 未分配
```
1.  在node1 上运行testpmd：
```bash
dpdk-testpmd -l 0-1 -n 1 -- -i
```
2. 将网卡设为只读模式、非混杂模式(这样就只收pktgen发来的包)后开始收包
```bash
set fwd rxonly
set promisc all off
show  port stats all
start
```
3. 在node2 运行pktgen 进行发包
```bash
pktgen -l 0-1 -n 3 -- -P -m "[1].0"
```
4. 设置目的mac，发送100个包
```bash
set 0 dst mac 00:0c:29:a5:21:1e
set 0 count 100
start 0
```
在node1上执行` show port stats all`,此时可以发现其中一张网卡多了6400，pktgen发包默认大小64字节。
执行`quit`退出
测试符合预期，环境搭建完成。